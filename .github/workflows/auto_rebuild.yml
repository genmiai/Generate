name: ğŸ¤—ç©ºé—´è‡ªåŠ¨æ„å»º

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

env:
  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  USERNAME: ${{ secrets.USERNAME }}
  EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
  EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
  EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: "587"
  SPACE_LIST: ${{ secrets.SPACE_LIST }}

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz
      - name: é‡æ–°æ„å»ºç©ºé—´
        id: rebuild
        run: |
          python <<EOF
          import requests, time, os, smtplib, datetime
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import pytz

          hf_token = os.environ["HF_TOKEN"]
          username = os.environ["USERNAME"]
          email_sender = os.environ["EMAIL_SENDER"]
          email_password = os.environ["EMAIL_PASSWORD"]
          email_receiver = os.environ["EMAIL_RECEIVER"].split(",")
          smtp_server = os.environ.get("SMTP_SERVER", "smtp.gmail.com")
          smtp_port = int(os.environ.get("SMTP_PORT", 587))
          space_list_str = os.environ.get("SPACE_LIST", "")
          space_list = [space.strip() for space in space_list_str.split(",") if space.strip()]

          def rebuild_space(space_name):
              full_space_name = f"{username}/{space_name}"
              print(f"\n{'-'*50}")
              print(f"ğŸ”„æ­£åœ¨é‡æ–°æ„å»ºç©ºé—´: {full_space_name}")
              rebuild_url = f"https://huggingface.co/api/spaces/{full_space_name}/restart?factory=true"
              status_url = f"https://huggingface.co/api/spaces/{full_space_name}/runtime"
              headers = {"Authorization": f"Bearer {hf_token}", "Content-Type": "application/json"}
              try:
                  response = requests.post(rebuild_url, headers=headers)
                  response.raise_for_status()
                  print("âœ…é‡æ–°æ„å»ºè¯·æ±‚å·²å‘é€æˆåŠŸ")

                  max_attempts = 10
                  for attempt in range(max_attempts):
                      print(f"â³ç­‰å¾…30ç§’åæ£€æŸ¥çŠ¶æ€... (å°è¯• {attempt+1}/{max_attempts})")
                      time.sleep(30)
                      status_response = requests.get(status_url, headers=headers)
                      status_response.raise_for_status()
                      status_data = status_response.json()
                      stage = status_data.get("stage", "")
                      print(f"å½“å‰çŠ¶æ€: {stage}")
                      if stage == "RUNNING":
                          print(f"âœ…ç©ºé—´{space_name}å·²æˆåŠŸé‡æ–°æ„å»º!")
                          return True
                      elif stage == "RUNNING_BUILDING":
                          print("ğŸ—ï¸ç©ºé—´æ­£åœ¨æ„å»ºä¸­...")
                      elif "ERROR" in stage:
                          print(f"âŒæ£€æµ‹åˆ°é”™è¯¯:{stage}")
                          return False
                  print("âš ï¸è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥")
                  return None
              except requests.exceptions.RequestException as e:
                  print(f"âŒè¯·æ±‚é”™è¯¯: {e}")
                  return False
              except Exception as e:
                  print(f"âŒå‘ç”Ÿé”™è¯¯: {e}")
                  return False

          def send_email(subject, body, html_body):
              msg = MIMEMultipart("alternative")
              msg["Subject"] = subject
              msg["From"] = email_sender
              msg["To"] = ", ".join(email_receiver)

              part1 = MIMEText(body, "plain")
              part2 = MIMEText(html_body, "html")
              msg.attach(part1)
              msg.attach(part2)

              try:
                  with smtplib.SMTP(smtp_server, smtp_port) as server:
                      server.starttls()
                      server.login(email_sender, email_password)
                      server.send_message(msg)
                  print("âœ…é‚®ä»¶å‘é€æˆåŠŸ")
              except Exception as e:
                  print(f"âŒé‚®ä»¶å‘é€å¤±è´¥: {e}")

          if not space_list:
              print("âš ï¸SPACE_LISTä¸ºç©ºï¼Œæ²¡æœ‰éœ€è¦é‡æ–°æ„å»ºçš„ç©ºé—´ã€‚")
              summary_plain = "âš ï¸SPACE_LISTä¸ºç©ºï¼Œæ²¡æœ‰éœ€è¦é‡æ–°æ„å»ºçš„ç©ºé—´ã€‚"
              summary_html = f"<p>{summary_plain}</p>"
              now = datetime.datetime.now(pytz.timezone('Asia/Shanghai'))
              date_string = now.strftime("%mæœˆ%dæ—¥")
              send_email(f"ğŸ¤—ç©ºé—´æ„å»ºç»“æœ", summary_plain, summary_html)
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  print(f"summary<<EOF", file=f)
                  print(summary_plain, file=f)
                  print(f"EOF", file=f)
                  print(f"exit_code=0", file=f)
              exit(0)

          print(f"ğŸš€å‡†å¤‡é‡æ–°æ„å»ºä»¥ä¸‹æŠ±æŠ±è„¸ç©ºé—´: {', '.join(space_list)}")
          success_spaces = []
          failed_spaces = []
          unknown_spaces = []
          for space in space_list:
              result = rebuild_space(space)
              if result is True:
                  success_spaces.append(space)
              elif result is False:
                  failed_spaces.append(space)
              else:
                  unknown_spaces.append(space)

          summary_plain = f"æ€»è®¡ç©ºé—´æ•°: {len(space_list)}\n"
          summary_plain += f"æˆåŠŸæ•°é‡: {len(success_spaces)}\n"
          summary_plain += f"å¤±è´¥æ•°é‡: {len(failed_spaces)}\n"
          summary_plain += f"æœªçŸ¥çŠ¶æ€æ•°é‡: {len(unknown_spaces)}\n"
          summary_plain += f"{'-'*50}\nå…·ä½“ç»“æœ:\n"
          summary_plain += "\n".join([f"âœ… {space}" for space in success_spaces])
          summary_plain += "\n".join([f"âŒ {space}" for space in failed_spaces])
          summary_plain += "\n".join([f"â“ {space}" for space in unknown_spaces])

          summary_html = f"""
          <html>
          <head>
              <style>
                  body {{
                      font-family: 'Arial', sans-serif;
                      margin: 20px;
                      line-height: 1.6;
                      color: #333;
                  }}
                  h1 {{
                      color: #0056b3; /* Dark blue */
                  }}
                  h2 {{
                      color: #0056b3; /* Dark blue */
                  }}
                  p {{
                      margin-bottom: 10px;
                  }}
                  .container {{
                      max-width: 600px;
                      margin: 0 auto;
                      padding: 20px;
                      border: 1px solid #eee;
                      border-radius: 5px;
                      background-color: #f9f9f9;
                  }}
                  .result-item {{
                      margin-bottom: 5px;
                      padding: 8px 12px;
                      border-radius: 4px;
                  }}
                  .success {{
                      background-color: #d4edda; /* Success green */
                      color: #155724;
                  }}
                  .failure {{
                      background-color: #f8d7da; /* Danger red */
                      color: #721c24;
                  }}
                  .unknown {{
                      background-color: #fff3cd; /* Warning yellow */
                      color: #856404;
                  }}
                  strong {{
                    font-weight: bold;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ¤—ç©ºé—´æ„å»ºç»“æœ</h1>
                  <p><strong>æ—¥æœŸ:</strong> {datetime.datetime.now(pytz.timezone('Asia/Shanghai')).strftime("%Y-%m-%d %H:%M:%S")}</p>
                  <p><strong>æ€»è®¡ç©ºé—´æ•°:</strong> {len(space_list)}</p>
                  <p><strong>æˆåŠŸæ•°é‡:</strong> <span class='success'>{len(success_spaces)}</span></p>
                  <p><strong>å¤±è´¥æ•°é‡:</strong> <span class='failure'>{len(failed_spaces)}</span></p>
                  <p><strong>æœªçŸ¥çŠ¶æ€æ•°é‡:</strong> <span class='unknown'>{len(unknown_spaces)}</span></p>
                  <h2>å…·ä½“ç»“æœ:</h2>
                  <ul>
                      {"".join([f"<li class='result-item success'>âœ… {space}</li>" for space in success_spaces])}
                      {"".join([f"<li class='result-item failure'>âŒ {space}</li>" for space in failed_spaces])}
                      {"".join([f"<li class='result-item unknown'>â“ {space}</li>" for space in unknown_spaces])}
                  </ul>
              </div>
          </body>
          </html>
          """

          now = datetime.datetime.now(pytz.timezone('Asia/Shanghai'))
          date_string = now.strftime("%mæœˆ%dæ—¥")
          send_email(f"ğŸ¤—ç©ºé—´æ„å»ºç»“æœ", summary_plain, summary_html)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              print(f"summary<<EOF", file=f)
              print(summary_plain, file=f)
              print(f"EOF", file=f)
              print(f"exit_code={1 if failed_spaces or unknown_spaces else 0}", file=f)
          if failed_spaces or unknown_spaces:
              exit(1)
          else:
              exit(0)
          EOF
      - name: æ£€æŸ¥é‡æ–°æ„å»ºç»“æœ
        if: always()
        run: |
          exit ${{ steps.rebuild.outputs.exit_code }}
      - name: å®ŒæˆçŠ¶æ€
        if: always()
        run: |
          echo "ğŸæ„å»ºæµç¨‹å·²å®Œæˆ"
