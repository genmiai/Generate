name: é‡æ–°æ„å»ºHuggingFaceç©ºé—´

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤© UTC 20:00 (åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4:00) æ‰§è¡Œ
env:
  HF_TOKEN: ""
  USERNAME: ""
  EMAIL_SENDER: ""
  EMAIL_PASSWORD: ""
  EMAIL_RECEIVER: ""
  SMTP_SERVER: "smtp.gmail.com"
  SMTP_PORT: "587"
  SPACE_LIST: ""

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v2
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: é‡æ–°æ„å»ºç©ºé—´
        id: rebuild
        run: |
          python <<EOF
          import requests,time,os,smtplib
          from email.mime.text import MIMEText
          HF_TOKEN=os.environ['HF_TOKEN']
          USERNAME=os.environ['USERNAME']
          EMAIL_SENDER=os.environ['EMAIL_SENDER']
          EMAIL_PASSWORD=os.environ['EMAIL_PASSWORD']
          EMAIL_RECEIVER=os.environ['EMAIL_RECEIVER'].split(',')
          SMTP_SERVER=os.environ.get('SMTP_SERVER','smtp.gmail.com')
          SMTP_PORT=int(os.environ.get('SMTP_PORT',587))
          SPACE_LIST=os.environ['SPACE_LIST'].split(',')
          def rebuild_space(space_name):
              full_space_name=f"{USERNAME}/{space_name}"
              print(f"\n{'='*50}")
              print(f"ğŸ”„å¼€å§‹é‡æ–°æ„å»ºç©ºé—´:{full_space_name}")
              rebuild_url=f"https://huggingface.co/api/spaces/{full_space_name}/restart?factory=true"
              status_url=f"https://huggingface.co/api/spaces/{full_space_name}/runtime"
              headers={"Authorization":f"Bearer {HF_TOKEN}","Content-Type":"application/json"}
              try:
                  response=requests.post(rebuild_url,headers=headers)
                  if response.status_code==200:
                      print(f"âœ…é‡æ–°æ„å»ºè¯·æ±‚å·²å‘é€æˆåŠŸ")
                      max_attempts=10
                      for attempt in range(max_attempts):
                          print(f"â³ç­‰å¾…30ç§’åæ£€æŸ¥çŠ¶æ€...(å°è¯•{attempt+1}/{max_attempts})")
                          time.sleep(30)
                          try:
                              status_response=requests.get(status_url,headers=headers)
                              if status_response.status_code==200:
                                  status_data=status_response.json()
                                  stage=status_data.get("stage","")
                                  print(f"å½“å‰çŠ¶æ€:{stage}")
                                  if stage=="RUNNING":
                                      print(f"âœ…ç©ºé—´{space_name}å·²æˆåŠŸé‡æ–°æ„å»º!")
                                      return True
                                  elif stage=="RUNNING_BUILDING":
                                      print("ğŸ—ï¸ç©ºé—´æ­£åœ¨æ„å»ºä¸­...")
                                  elif"ERROR"in stage:
                                      print(f"âŒæ£€æµ‹åˆ°é”™è¯¯:{stage}")
                                      return False
                              else:
                                  print(f"âš ï¸è·å–çŠ¶æ€å¤±è´¥ï¼ŒçŠ¶æ€ç :{status_response.status_code}")
                          except requests.RequestException as e:
                              print(f"âš ï¸è¯·æ±‚å¼‚å¸¸:{str(e)}")
                      print("âš ï¸è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥")
                      return None
                  else:
                      print(f"âŒé‡æ–°æ„å»ºè¯·æ±‚å¤±è´¥.çŠ¶æ€ç :{response.status_code}")
                      print(f"å“åº”å†…å®¹:{response.text}")
                      return False
              except Exception as e:
                  print(f"âŒå‘ç”Ÿé”™è¯¯:{str(e)}")
                  return False
          def send_email(subject,body):
              msg=MIMEText(body)
              msg['Subject']=subject
              msg['From']=EMAIL_SENDER
              msg['To']=', '.join(EMAIL_RECEIVER)
              try:
                  with smtplib.SMTP(SMTP_SERVER,SMTP_PORT)as server:
                      server.starttls()
                      server.login(EMAIL_SENDER,EMAIL_PASSWORD)
                      server.send_message(msg)
                  print("âœ…é‚®ä»¶å‘é€æˆåŠŸ")
              except Exception as e:
                  print(f"âŒé‚®ä»¶å‘é€å¤±è´¥:{str(e)}")
          success_spaces=[]
          failed_spaces=[]
          unknown_spaces=[]
          print(f"ğŸš€å‡†å¤‡é‡æ–°æ„å»ºä»¥ä¸‹ç©ºé—´:{','.join(SPACE_LIST)}")
          for space in SPACE_LIST:
              result=rebuild_space(space)
              if result is True:
                  success_spaces.append(space)
              elif result is False:
                  failed_spaces.append(space)
              else:
                  unknown_spaces.append(space)
          summary=f"æ€»è®¡ç©ºé—´æ•°:{len(SPACE_LIST)}\n"
          summary+=f"æˆåŠŸæ•°é‡:{len(success_spaces)}\n"
          summary+=f"å¤±è´¥æ•°é‡:{len(failed_spaces)}\n"
          summary+=f"æœªçŸ¥çŠ¶æ€æ•°é‡:{len(unknown_spaces)}\n"
          summary+="---\nå…·ä½“ç»“æœ:\n"
          summary+="\n".join([f"âœ…{space}é‡æ–°æ„å»ºæˆåŠŸ"for space in success_spaces])
          summary+="\n".join([f"âŒ{space}é‡æ–°æ„å»ºå¤±è´¥"for space in failed_spaces])
          summary+="\n".join([f"â“{space}é‡æ–°æ„å»ºçŠ¶æ€æœªçŸ¥"for space in unknown_spaces])
          print("\n"+"="*50)
          print("ğŸ“Šé‡æ–°æ„å»ºæ€»ç»“:")
          print(summary)
          send_email("Hugging Faceç©ºé—´é‡æ–°æ„å»ºç»“æœ",summary)
          with open(os.environ['GITHUB_OUTPUT'],'a')as f:
              print("summary<<EOF",file=f)
              print(summary,file=f)
              print("EOF",file=f)
              print(f"exit_code={1 if failed_spaces or unknown_spaces else 0}",file=f)
          if failed_spaces or unknown_spaces:
              exit(1)
          else:
              exit(0)
          EOF
      - name: æ£€æŸ¥é‡æ–°æ„å»ºç»“æœ
        if: always()
        run: |
          exit ${{ steps.rebuild.outputs.exit_code }}
      - name: å®ŒæˆçŠ¶æ€
        if: always()
        run: |
          echo "ğŸé‡æ–°æ„å»ºæµç¨‹å·²å®Œæˆ"
